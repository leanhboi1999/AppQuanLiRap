alter TABLE CTHDTP
DROP CONSTRAINT FK_CTHDTP_HDTHUCPHAM;
ALTER TABLE CTHDTP
DROP CONSTRAINT FK_CTHDTP_THUCPHAM;
ALTER TABLE CTPQ
DROP CONSTRAINT FK_CTPQ_CTPQ_PHANQUYE;
ALTER TABLE CTPQ
DROP CONSTRAINT FK_CTPQ_CTPQ2_TAIKHOAN;
ALTER TABLE GHE
DROP CONSTRAINT FK_GHE_THUOC7_PHONGCHI;
ALTER TABLE HDTHUCPHAM
DROP CONSTRAINT FK_HDTHUCPH_LAP_NHANVIEN;
ALTER TABLE NHANVIEN
DROP CONSTRAINT FK_NHANVIEN_DANGNHAP_TAIKHOAN;
ALTER TABLE NHANVIEN
DROP CONSTRAINT FK_NHANVIEN_LA_CHUCVU;
ALTER TABLE SUATCHIEU
DROP CONSTRAINT FK_SUATCHIE_THUOC3_SUATPHIM;
ALTER TABLE SUATCHIEU
DROP CONSTRAINT FK_SUATCHIE_THUOC6_PHONGCHI;
ALTER TABLE SUATPHIM
DROP CONSTRAINT FK_SUATPHIM_CO_PHIM;
ALTER TABLE SUATPHIM
DROP CONSTRAINT FK_SUATPHIM_CO1_DINHDANG;
ALTER TABLE SUATPHIM
DROP CONSTRAINT FK_SUATPHIM_CO2_HINHTHUC;
ALTER TABLE SUATPHIM
DROP CONSTRAINT FK_SUATPHIM_CO3_NGONNGU;
ALTER TABLE TAIKHOAN
DROP CONSTRAINT FK_TAIKHOAN_DANGNHAP2_NHANVIEN;
ALTER TABLE VE
DROP CONSTRAINT FK_VE_BAN_NHANVIEN;
ALTER TABLE VE
DROP CONSTRAINT FK_VE_MUA_HOIVIEN;
ALTER TABLE VE
DROP CONSTRAINT FK_VE_THUOC_SUKIEN;
ALTER TABLE VE
DROP CONSTRAINT FK_VE_THUOC2_SUATCHIE;
ALTER TABLE VE
DROP CONSTRAINT FK_VE_THUOC8_GHE;
DROP TABLE CHUCVU CASCADE CONSTRAINTS;
DROP INDEX CTH_TP2_FK;
DROP INDEX CTH_TP_FK;
DROP TABLE CTH_TP CASCADE CONSTRAINTS;
DROP INDEX CTPQ2_FK;
DROP INDEX CTPQ_FK;
DROP TABLE CTPQ CASCADE CONSTRAINTS;
DROP TABLE DINHDANG CASCADE CONSTRAINTS;
DROP INDEX THUOC7_FK;
DROP TABLE GHE CASCADE CONSTRAINTS;
DROP INDEX LAP_FK;
DROP TABLE HDTHUCPHAM CASCADE CONSTRAINTS;
DROP TABLE HINHTHUC CASCADE CONSTRAINTS;
DROP TABLE HOIVIEN CASCADE CONSTRAINTS;
DROP TABLE NGONNGU CASCADE CONSTRAINTS;
DROP INDEX LA_FK;
DROP INDEX DANGNHAP_FK;
DROP TABLE NHANVIEN CASCADE CONSTRAINTS;
DROP TABLE PHANQUYEN CASCADE CONSTRAINTS;
DROP TABLE PHIM CASCADE CONSTRAINTS;
DROP TABLE PHONGCHIEU CASCADE CONSTRAINTS;
DROP INDEX THUOC6_FK;
DROP INDEX THUOC3_FK;
DROP TABLE SUATCHIEU CASCADE CONSTRAINTS;
DROP INDEX CO2_FK;
DROP INDEX CO3_FK;
DROP INDEX CO1_FK;
DROP INDEX CO_FK;
DROP TABLE SUATPHIM CASCADE CONSTRAINTS;
DROP TABLE SUKIEN CASCADE CONSTRAINTS;
DROP INDEX DANGNHAP2_FK;
DROP TABLE TAIKHOAN CASCADE CONSTRAINTS;
DROP TABLE THUCPHAM CASCADE CONSTRAINTS;
DROP INDEX THUOC8_FK;
DROP INDEX MUA_FK;
DROP INDEX THUOC2_FK;
DROP INDEX THUOC_FK;
DROP INDEX BAN_FK;
DROP TABLE CTHDTP CASCADE CONSTRAINTS;
DROP TABLE VE CASCADE CONSTRAINTS;
DROP PROCEDURE pro_auto_insert_mahd_cthd;
DROP PROCEDURE pro_banve_ghe;
DROP PROCEDURE PRO_INSERT_GHE;
DROP PROCEDURE PRO_HIENTHI_SUATCHIEU;
DROP FUNCTION ID_GHE;
DROP FUNCTION ID_HOADON;
DROP FUNCTION ID_HOIVIEN;
DROP FUNCTION ID_NHANVIEN;
DROP FUNCTION ID_PHIM;
DROP FUNCTION ID_SUATCHIEU;
DROP FUNCTION ID_SUATPHIM;
DROP FUNCTION ID_VE;
DROP FUNCTION AUTO_NGAYLAP;
/*==============================================================*/
/* Table: CHUCVU                                                */
/*==============================================================*/
CREATE TABLE CHUCVU
  (
    MACHUCVU NVARCHAR2(7) NOT NULL,
    TENCHUCVU NVARCHAR2(50),
    LUONGCOBAN NUMBER(10,2),
    CONSTRAINT PK_CHUCVU PRIMARY KEY (MACHUCVU)
  );
/*==============================================================*/
/* Table: CTH_TP                                                */
/*==============================================================*/
CREATE TABLE CTHDTP
  (
    MAHOADON NVARCHAR2(7) NOT NULL,
    MATHUCPHAM NVARCHAR2(7) NOT NULL,
    SOLUONG INTEGER,
    CONSTRAINT PK_CTH_TP PRIMARY KEY (MAHOADON, MATHUCPHAM)
  );
/*==============================================================*/
/* Table: DINHDANG                                              */
/*==============================================================*/
CREATE TABLE DINHDANG
  (
    MADINHDANG NVARCHAR2(7) NOT NULL,
    TENDINHDANG NVARCHAR2(255),
    GIADINHDANG NUMBER(10,2),
    CONSTRAINT PK_DINHDANG PRIMARY KEY (MADINHDANG)
  );
/*==============================================================*/
/* Table: GHE                                                   */
/*==============================================================*/
CREATE TABLE GHE
  (
    MAGHE NVARCHAR2(7) NOT NULL,
    MAPHONG NVARCHAR2(7) NOT NULL,
    SOGHE INTEGER,
    CONSTRAINT PK_GHE PRIMARY KEY (MAGHE)
  );
/*==============================================================*/
/* Table: HDTHUCPHAM                                            */
/*==============================================================*/
CREATE TABLE HDTHUCPHAM
  (
    MAHOADON NVARCHAR2(7) NOT NULL,
    MANHANVIEN NVARCHAR2(7) NOT NULL,
    SOTIEN  NUMBER(10,2),
    NGAYLAP DATE,
    CONSTRAINT PK_HDTHUCPHAM PRIMARY KEY (MAHOADON)
  );
/*==============================================================*/
/* Table: HINHTHUC                                              */
/*==============================================================*/
CREATE TABLE HINHTHUC
  (
    MAHINHTHUC NVARCHAR2(7) NOT NULL,
    TENHINHTHUC NVARCHAR2(255),
    CONSTRAINT PK_HINHTHUC PRIMARY KEY (MAHINHTHUC)
  );
/*==============================================================*/
/* Table: HOIVIEN                                               */
/*==============================================================*/
CREATE TABLE HOIVIEN
  (
    MAHOIVIEN NVARCHAR2(7) NOT NULL,
    HOTEN NVARCHAR2(50),
    GIOITINH NVARCHAR2(3),
    CMND NVARCHAR2(15),
    NGAYSINH DATE,
    EMAIL NVARCHAR2(50),
    DIENTHOAI NVARCHAR2(15),
    NGAYDANGKY  DATE,
    DIEMTICHLUY INTEGER,
    CONSTRAINT PK_HOIVIEN PRIMARY KEY (MAHOIVIEN)
  );
/*==============================================================*/
/* Table: NGONNGU                                               */
/*==============================================================*/
CREATE TABLE NGONNGU
  (
    MANGONNGU NVARCHAR2(7) NOT NULL,
    TENNGONNGU NVARCHAR2(20),
    CONSTRAINT PK_NGONNGU PRIMARY KEY (MANGONNGU)
  );
/*==============================================================*/
/* Table: NHANVIEN                                              */
/*==============================================================*/
CREATE TABLE NHANVIEN
  (
    MANHANVIEN NVARCHAR2(7) NOT NULL,
    MACHUCVU NVARCHAR2(7) NOT NULL,
    HOTEN NVARCHAR2(50),
    EMAIL NVARCHAR2(50),
    CMND NVARCHAR2(15),
    GIOITINH NVARCHAR2(3),
    NGAYSINH DATE,
    DIACHI NVARCHAR2(120),
    DIENTHOAI NVARCHAR2(15),
    NGAYVAOLAM DATE,
    TRANGTHAI  INTEGER,
    CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANHANVIEN)
  );
/*==============================================================*/
/* Table: PHANQUYEN                                             */
/*==============================================================*/
CREATE TABLE PHANQUYEN
  (
    MAQUYEN NVARCHAR2(7) NOT NULL,
    TENQUYEN NVARCHAR2(50),
    CONSTRAINT PK_PHANQUYEN PRIMARY KEY (MAQUYEN)
  );
/*==============================================================*/
/* Table: PHIM                                                  */
/*==============================================================*/
CREATE TABLE PHIM
  (
    MAPHIM NVARCHAR2(7) NOT NULL,
    TENPHIM NVARCHAR2(120),
    THOILUONG NUMBER(4),
    THELOAI NVARCHAR2(50),
    NHASANXUAT NVARCHAR2(120),
    NAMSANXUAT INTEGER,
    DIENVIEN NVARCHAR2(120),
    NUOCSANXUAT NVARCHAR2(50),
    NGAYKHOICHIEU DATE,
    GIOIHANTUOI   INTEGER,
    TOMTAT NVARCHAR2(120),
    TRANGTHAI NVARCHAR2(20),
    CONSTRAINT PK_PHIM PRIMARY KEY (MAPHIM)
  );
/*==============================================================*/
/* Table: PHONGCHIEU                                            */
/*==============================================================*/
CREATE TABLE PHONGCHIEU
  (
    MAPHONG NVARCHAR2(7) NOT NULL,
    TENPHONG NVARCHAR2(255),
    SLGHE INTEGER,
    CONSTRAINT PK_PHONGCHIEU PRIMARY KEY (MAPHONG)
  );
/*==============================================================*/
/* Table: SUATCHIEU                                             */
/*==============================================================*/
CREATE TABLE SUATCHIEU
  (
    MASUATCHIEU NVARCHAR2(7) NOT NULL,
    MAPHONG NVARCHAR2(7) NOT NULL,
    MASUATPHIM NVARCHAR2(7) NOT NULL,
    THOIGIANCHIEU TIMESTAMP,
    TRANGTHAI NVARCHAR2(20),
    CONSTRAINT PK_SUATCHIEU PRIMARY KEY (MASUATCHIEU)
  );
/*==============================================================*/
/* Table: SUATPHIM                                              */
/*==============================================================*/
CREATE TABLE SUATPHIM
  (
    MASUATPHIM NVARCHAR2(7) NOT NULL,
    MANGONNGU NVARCHAR2(7) NOT NULL,
    MADINHDANG NVARCHAR2(7) NOT NULL,
    MAPHIM NVARCHAR2(7) NOT NULL,
    MAHINHTHUC NVARCHAR2(7) NOT NULL,
    CONSTRAINT PK_SUATPHIM PRIMARY KEY (MASUATPHIM)
  );
/*==============================================================*/
/* Table: SUKIEN                                                */
/*==============================================================*/
CREATE TABLE SUKIEN
  (
    MASUKIEN NVARCHAR2(7) NOT NULL,
    TENSUKIEN NVARCHAR2(50),
    MOTA NVARCHAR2(150),
    GIAMGIA FLOAT,
    NGAYBATDAU  DATE,
    NGAYKETTHUC DATE,
    CONSTRAINT PK_SUKIEN PRIMARY KEY (MASUKIEN)
  );
/*==============================================================*/
/* Table: TAIKHOAN                                              */
/*==============================================================*/
CREATE TABLE TAIKHOAN
  (
    MANHANVIEN NVARCHAR2(7) NOT NULL,
    MAT_KHAU NVARCHAR2(20),
    MAQUYEN NVARCHAR2(7)
  );
/*==============================================================*/
/* Table: THUCPHAM                                              */
/*==============================================================*/
CREATE TABLE THUCPHAM
  (
    MATHUCPHAM NVARCHAR2(7) NOT NULL,
    TENTHUCPHAM NVARCHAR2(50),
    DONGIA    NUMBER(10,2),
    SLUONG    INTEGER,
    TRANGTHAI INTEGER,
    CONSTRAINT PK_THUCPHAM PRIMARY KEY (MATHUCPHAM)
  );
/*==============================================================*/
/* Table: VE                                                    */
/*==============================================================*/
CREATE TABLE VE
  (
    MAVE NVARCHAR2(7) NOT NULL,
    MASUATCHIEU NVARCHAR2(7) NOT NULL,
    MANHANVIEN NVARCHAR2(7) NOT NULL,
    MASUKIEN NVARCHAR2(7) NOT NULL,
    MAHOIVIEN NVARCHAR2(7) NOT NULL,
    MAGHE NVARCHAR2(7) NOT NULL,
    NGAYLAP DATE,
    GIAVE   NUMBER(10,2),
    CONSTRAINT PK_VE PRIMARY KEY (MAVE)
  );
ALTER TABLE CTHDTP ADD CONSTRAINT FK_CTHDTP_HDTHUCPHAM FOREIGN KEY (MAHOADON) REFERENCES HDTHUCPHAM (MAHOADON);
ALTER TABLE CTHDTP ADD CONSTRAINT FK_CTHDTP_THUCPHAM FOREIGN KEY (MATHUCPHAM) REFERENCES THUCPHAM (MATHUCPHAM);
ALTER TABLE GHE ADD CONSTRAINT FK_GHE_PHONGCHIEU FOREIGN KEY (MAPHONG) REFERENCES PHONGCHIEU (MAPHONG);
ALTER TABLE HDTHUCPHAM ADD CONSTRAINT FK_HDTHUCPHAM_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN (MANHANVIEN);
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_NHANVIEN_CHUCVU FOREIGN KEY (MACHUCVU) REFERENCES CHUCVU (MACHUCVU);
ALTER TABLE SUATCHIEU ADD CONSTRAINT FK_SUATCHIEU_SUATPHIM FOREIGN KEY (MASUATPHIM) REFERENCES SUATPHIM (MASUATPHIM);
ALTER TABLE SUATCHIEU ADD CONSTRAINT FK_SUATCHIEU_PHONGCHIEU FOREIGN KEY (MAPHONG) REFERENCES PHONGCHIEU (MAPHONG);
ALTER TABLE SUATPHIM ADD CONSTRAINT FK_SUATPHIM_PHIM FOREIGN KEY (MAPHIM) REFERENCES PHIM (MAPHIM);
ALTER TABLE SUATPHIM ADD CONSTRAINT FK_SUATPHIM_DINHDANG FOREIGN KEY (MADINHDANG) REFERENCES DINHDANG (MADINHDANG);
ALTER TABLE SUATPHIM ADD CONSTRAINT FK_SUATPHIM_HINHTHUC FOREIGN KEY (MAHINHTHUC) REFERENCES HINHTHUC (MAHINHTHUC);
ALTER TABLE SUATPHIM ADD CONSTRAINT FK_SUATPHIM_NGONNGU FOREIGN KEY (MANGONNGU) REFERENCES NGONNGU (MANGONNGU);
ALTER TABLE TAIKHOAN ADD CONSTRAINT FK_TAIKHOAN_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN (MANHANVIEN);
ALTER TABLE VE ADD CONSTRAINT FK_VE_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN (MANHANVIEN);
ALTER TABLE VE ADD CONSTRAINT FK_VE_HOIVIEN FOREIGN KEY (MAHOIVIEN) REFERENCES HOIVIEN (MAHOIVIEN);
ALTER TABLE VE ADD CONSTRAINT FK_VE_SUKIEN FOREIGN KEY (MASUKIEN) REFERENCES SUKIEN (MASUKIEN);
ALTER TABLE VE ADD CONSTRAINT FK_VE_SUATCHIEU FOREIGN KEY (MASUATCHIEU) REFERENCES SUATCHIEU (MASUATCHIEU);
ALTER TABLE VE ADD CONSTRAINT FK_VE_GHE FOREIGN KEY (MAGHE) REFERENCES GHE (MAGHE);
--CHO DỮ LIỆU VÀO
--CHO BẢNG CHỨC VỤ
DELETE FROM CHUCVU;
INSERT INTO CHUCVU VALUES
  ('CV00001','QUẢN LÝ',10000000
  );
INSERT INTO CHUCVU VALUES
  ('CV00002','BẢO VỆ',6000000
  );
INSERT INTO CHUCVU VALUES
  ('CV00003','BÁN THỰC PHẨM',6000000
  );
INSERT INTO CHUCVU VALUES
  ('CV00004','KẾ TOÁN',8000000
  );
INSERT INTO CHUCVU VALUES
  ('CV00005','BÁN VÉ',5000000
  );
--CHO BẢNG ĐỊNH DẠNG
DELETE FROM DINHDANG;
INSERT INTO DINHDANG VALUES
  ('DD00001','2D','35000'
  );
INSERT INTO DINHDANG VALUES
  ('DD00002','3D','40000'
  );
INSERT INTO DINHDANG VALUES
  ('DD00003','4D','45000'
  );
INSERT INTO DINHDANG VALUES
  ('DD00004','5D','50000'
  );
--CHO BẢNG HÌNH THỨC
DELETE FROM HINHTHUC;
INSERT INTO HINHTHUC VALUES
  ('HT00001','PHU DE TIENG VIET'
  );
INSERT INTO HINHTHUC VALUES
  ('HT00002','PHU DE TIENG ANH'
  );
INSERT INTO HINHTHUC VALUES
  ('HT00003','LONG TIENG'
  );
INSERT INTO HINHTHUC VALUES
  ('HT00004','THUYET MINH'
  );
--CHO BẢNG NGÔN NGỮ
DELETE FROM NGONNGU;
INSERT INTO NGONNGU VALUES
  ('NN00001','TIENG ANH'
  );
INSERT INTO NGONNGU VALUES
  ('NN00002','TIENG VIET'
  );
INSERT INTO NGONNGU VALUES
  ('NN00003','TIENG TRUNG'
  );
INSERT INTO NGONNGU VALUES
  ('NN00004','TIENG HAN'
  );
--CHO BẢNG HỘI VIÊN
DELETE FROM HOIVIEN;
INSERT
INTO HOIVIEN VALUES
  (
    'HV00001',
    'ĐẶNG THỊ THÙY NHI',
    'NỮ',
    '123456789',
    TO_DATE('27/04/2000','dd/mm/yyyy'),
    'nhi@gmail.com',
    '0923567812',
    '',
    0
  );
INSERT
INTO HOIVIEN VALUES
  (
    'HV00002',
    'LÊ ĐỨC ANH',
    'NAM',
    '65758745',
    TO_DATE('27/09/1999','dd/mm/yyyy'),
    'anh@gmail.com',
    '0923567862',
    '',
    0
  );
INSERT
INTO HOIVIEN VALUES
  (
    'HV00003',
    'NGUYỄN NGỌC HUY',
    'NAM',
    '1234566579',
    TO_DATE('15/03/1999','dd/mm/yyyy'),
    'huy@gmail.com',
    '092117812',
    '',
    0
  );
INSERT
INTO HOIVIEN VALUES
  (
    'HV00004',
    'NGUYỄN THANH VÂN',
    'NỮ',
    '653456789',
    TO_DATE('12/06/2000','dd/mm/yyyy'),
    'van@gmail.com',
    '0923567572',
    '',
    0
  );
CREATE OR REPLACE TRIGGER AUTO_DANGKI_HOIVIEN BEFORE
  INSERT OR
  UPDATE ON HOIVIEN FOR EACH ROW BEGIN :NEW.NGAYDANGKY := SYSDATE();
END;
--TRIGGER NGÀY VÀO LÀM
CREATE OR REPLACE TRIGGER AUTO_DANGKI_NHANVIEN BEFORE
  INSERT OR
  UPDATE ON NHANVIEN FOR EACH ROW BEGIN :NEW.NGAYVAOLAM := SYSDATE();
END;
--INSERT VÀO BẢNG THỰC PHẨM
DELETE FROM THUCPHAM;
INSERT INTO THUCPHAM VALUES
  ('TP00001','BẮP RANG',30000,10,1
  );
INSERT INTO THUCPHAM VALUES
  ('TP00002','COCA',5000,50,1
  );
INSERT INTO THUCPHAM VALUES
  ('TP00003','KEM',8000,70,1
  );
INSERT INTO THUCPHAM VALUES
  ('TP00004','HAMBUGER',50000,20,1
  );
INSERT INTO THUCPHAM VALUES
  ('TP00005','PIZZA',90000,10,1
  );
--INSERT VÀO BẢNG NHÂN VIÊN
DELETE FROM NHANVIEN;
INSERT
INTO NHANVIEN VALUES
  (
    'NV00001',
    'CV00001',
    'NGUYỄN ANH TUẤN',
    'tuan@gmail.com',
    '56367586',
    'NAM',
    TO_DATE('12/06/1980','dd/mm/yyyy'),
    'QUẬN 1,TPHCM',
    '0898675745',
    TO_DATE('20/06/2011','dd/mm/yyyy'),
    0
  );
INSERT
INTO NHANVIEN VALUES
  (
    'NV00002',
    'CV00002',
    'TRẦN THÚY AN',
    'an@gmail.com',
    '76578467',
    'NAM',
    TO_DATE('18/06/1990','dd/mm/yyyy'),
    'QUẬN 3,TPHCM',
    '08756745',
    TO_DATE('30/06/2001','dd/mm/yyyy'),
    0
  );
INSERT
INTO NHANVIEN VALUES
  (
    'NV00003',
    'CV00002',
    'NGUYỄN HIẾU THẮNG',
    'thang@gmail.com',
    '7687874',
    'NAM',
    TO_DATE('22/06/1998','dd/mm/yyyy'),
    'QUẬN 4,TPHCM',
    '574675745',
    TO_DATE('15/05/2010','dd/mm/yyyy'),
    0
  );
INSERT
INTO NHANVIEN VALUES
  (
    'NV00004',
    'CV00003',
    'NGÔ MINH HƯNG',
    'hung@gmail.com',
    '57553245',
    'NAM',
    TO_DATE('30/03/1993','dd/mm/yyyy'),
    'QUẬN 5,TPHCM',
    '10938675745',
    TO_DATE('02/02/2016','dd/mm/yyyy'),
    0
  );
INSERT
INTO NHANVIEN VALUES
  (
    'NV00005',
    'CV00003',
    'NGÔ XUÂN HIẾU',
    'hieu@gmail.com',
    '5627884',
    'NAM',
    TO_DATE('05/05/1990','dd/mm/yyyy'),
    'QUẬN 6,TPHCM',
    '08654875745',
    TO_DATE('13/03/2017','dd/mm/yyyy'),
    0
  );
INSERT
INTO NHANVIEN VALUES
  (
    'NV00006',
    'CV00004',
    'NGUYỄN THANH THANH',
    'thanh@gmail.com',
    '56747884',
    'NAM',
    TO_DATE('05/05/1990','dd/mm/yyyy'),
    'QUẬN 1,TPHCM',
    '08654875745',
    TO_DATE('13/03/2017','dd/mm/yyyy'),
    0
  );
--INSERT VÀO BẢNG PHÂN QUYỀN
DELETE FROM PHANQUYEN;
INSERT INTO PHANQUYEN VALUES
  ('PQ00001','ADMIN'
  );
INSERT INTO PHANQUYEN VALUES
  ('PQ00002','BÁN VÉ'
  );
INSERT INTO PHANQUYEN VALUES
  ('PQ00003','BÁN THỰC PHẨM'
  );
INSERT INTO PHANQUYEN VALUES
  ('PQ00004','QUẢN LÝ PHIM'
  );
INSERT INTO PHANQUYEN VALUES
  ('PQ00005','QUẢN LÝ THỰC PHẨM'
  );
--INSERT VÀO BẢNG TÀI KHOẢN
DELETE FROM TAIKHOAN;
INSERT INTO TAIKHOAN VALUES
  ('NV00001','123456','PQ00001'
  );
INSERT INTO TAIKHOAN VALUES
  ('NV00002','123456','PQ00002'
  );
INSERT INTO TAIKHOAN VALUES
  ('NV00003','123456','PQ00003'
  );
--INSERT VÀO BẢNG PHÒNG CHIẾU
DELETE FROM PHONGCHIEU;
INSERT INTO PHONGCHIEU VALUES
  ('PC00001','PHÒNG 101',48
  );
INSERT INTO PHONGCHIEU VALUES
  ('PC00002','PHÒNG 205',48
  );
INSERT INTO PHONGCHIEU VALUES
  ('PC00003','PHÒNG 306',48
  );
INSERT INTO PHONGCHIEU VALUES
  ('PC00004','PHÒNG 303',48
  );
INSERT INTO PHONGCHIEU VALUES
  ('PC00005','PHÒNG 200',48
  );
--INSERT VÀO BẢNG PHIM
DELETE FROM PHIM;
INSERT
INTO PHIM VALUES
  (
    'PH00001',
    'MẮT BIẾC',
    180,
    'TÌNH CẢM',
    'VICTO VŨ',
    2019,
    'TRÚC ANH,TRẦN NGHĨA',
    'VIỆT NAM',
    TO_DATE('20/12/2019','dd/mm/yyyy'),
    16,
    'CHUYỆN TÌNH GIỮA NGẠN VÀ HÀ LAN',
    'ĐANG CHIẾU'
  );
INSERT
INTO PHIM VALUES
  (
    'PH00002',
    'CÔ 3 SÀI GON',
    100,
    'TÌNH CẢM',
    'NGÔ THANH VÂN',
    2017,
    'ST,NINH DƯƠNG LAN NGỌC',
    'VIỆT NAM',
    TO_DATE('21/03/2017','dd/mm/yyyy'),
    16,
    'ÁO DÀI VIỆT NAM',
    'SẮP CHIẾU'
  );
INSERT
INTO PHIM VALUES
  (
    'PH00003',
    'HAI PHƯỢNG',
    150,
    'HÀNH ĐỘNG',
    '',
    2015,
    'NGÔ THANH VÂN',
    'VIÊT NAM',
    TO_DATE('05/12/2015','dd/mm/yyyy'),
    18,
    'TÌNH MẪU TỮ',
    'SẮP CHIẾU'
  );
INSERT
INTO PHIM VALUES
  (
    'PH00004',
    'ANH THẦY NGÔI SAO',
    110,
    'HÀI',
    'ĐỨC THỊNH',
    2020,
    'THANH TÙNG,QUỲNH ANH',
    'VIỆT NAM',
    TO_DATE('03/02/2020','dd/mm/yyyy'),
    12,
    'NHIỆT HUYẾT CỦA NGƯỜI GIÁO VIÊN',
    'ĐANG CHIẾU'
  );
INSERT
INTO PHIM VALUES
  (
    'PH00005',
    'TRẠNG QUỲNH',
    120,
    'HÀI',
    'ĐỨC THỊNH',
    2018,
    'NHÃ PHƯƠNG,TRẤN THÀNH',
    'VIỆT NAM',
    TO_DATE('02/08/2018','dd/mm/yyyy'),
    12,
    'QUỲNH ĐI THI',
    'ĐÃ KẾT THÚC'
  );
--INSERT SUẤT PHIM
DELETE FROM SUATPHIM;
INSERT
INTO SUATPHIM VALUES
  (
    'SP00001',
    'NN00001',
    'DD00002',
    'PH00001',
    'HT00003'
  );
INSERT
INTO SUATPHIM VALUES
  (
    'SP00002',
    'NN00001',
    'DD00001',
    'PH00001',
    'HT00002'
  );
INSERT
INTO SUATPHIM VALUES
  (
    'SP00003',
    'NN00001',
    'DD00001',
    'PH00002',
    'HT00003'
  );
INSERT
INTO SUATPHIM VALUES
  (
    'SP00004',
    'NN00002',
    'DD00001',
    'PH00003',
    'HT00001'
  );
INSERT
INTO SUATPHIM VALUES
  (
    'SP00005',
    'NN00003',
    'DD00001',
    'PH00004',
    'HT00001'
  );
--INSERT SỰ KIỆN
DELETE FROM SUKIEN;
INSERT
INTO SUKIEN VALUES
  (
    'SK00001',
    'NGÀY 8-3',
    'NGÀY QUỐC TẾ PHỤ NỮ',
    0.05,
    TO_DATE('07/03/2020','DD/MM/YYYY'),
    TO_DATE('09/03/2020','DD/MM/YYYY')
  );
INSERT
INTO SUKIEN VALUES
  (
    'SK00002',
    'NGÀY 1-5',
    'NGÀY QUỐC TẾ LAO ĐỘNG',
    0.07,
    TO_DATE('30/04/2020','DD/MM/YYYY'),
    TO_DATE('02/05/2020','DD/MM/YYYY')
  );
INSERT
INTO SUKIEN VALUES
  (
    'SK00003',
    'NGÀY 1-6',
    'NGÀY QUỐC TẾ THIẾU NHI',
    0.12,
    TO_DATE('31/5/2020','DD/MM/YYYY'),
    TO_DATE('02/06/2020','DD/MM/YYYY')
  );
--INSERT SUẤT CHIẾU
DELETE FROM SUATCHIEU;
INSERT
INTO SUATCHIEU VALUES
  (
    'SC00001',
    'PC00001',
    'SP00001',
    TO_DATE('06/06/2019','dd/mm/yyyy'),
    'Còn chỗ'
  );
INSERT
INTO SUATCHIEU VALUES
  (
    'SC00002',
    'PC00002',
    'SP00003',
    TO_DATE('08/01/2020','dd/mm/yyyy'),
    'Còn chỗ'
  );
INSERT
INTO SUATCHIEU VALUES
  (
    'SC00003',
    'PC00004',
    'SP00002',
    TO_DATE('12/04/2018','dd/mm/yyyy'),
    'Còn chỗ'
  );
INSERT
INTO SUATCHIEU VALUES
  (
    'SC00004',
    'PC00003',
    'SP00002',
    TO_DATE('25/06/2017','dd/mm/yyyy'),
    'Còn chỗ'
  );
INSERT
INTO SUATCHIEU VALUES
  (
    'SC00005',
    'PC00003',
    'SP00001',
    TO_DATE('07/07/2019','dd/mm/yyyy'),
    'Còn chỗ'
  );
--INSERT BÁN VÉ
CREATE OR REPLACE TRIGGER AUTO_NGAYLAP_VE BEFORE
  INSERT OR
  UPDATE ON VE FOR EACH ROW BEGIN :NEW.NGAYLAP := SYSDATE();
END;
--TRIGGER TỰ ĐỘNG INSERT MÃ NHÂN VIÊN VÀO BẢNG TÀI KHOẢN
CREATE OR REPLACE TRIGGER TRIG_AUTO_INSERT_MANV_TAIKHOAN AFTER
  INSERT OR
  UPDATE ON NHANVIEN FOR EACH ROW BEGIN
  INSERT INTO TAIKHOAN VALUES
    (:NEW.MANHANVIEN,NULL,NULL
    );
END;
-- TẠO NGÀY LẬP
CREATE OR REPLACE FUNCTION AUTO_NGAYLAP
  RETURN DATE
AS
  NGAYLAP DATE;
BEGIN
  NGAYLAP := SYSDATE();
  RETURN ngaylap;
END;
--TẠO MÃ HÓA ĐƠN
CREATE OR REPLACE FUNCTION ID_HOADON
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MAHD     VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MAHOADON,-5,5) AS NUMBER))
  INTO LAST_VALUE
  FROM HDTHUCPHAM;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MAHD:=CONCAT('HD',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MAHD);
END;
--TẠO MÃ NHÂN VIÊN
CREATE OR REPLACE FUNCTION ID_NHANVIEN
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MANV     VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MANHANVIEN,-5,5) AS NUMBER))
  INTO LAST_VALUE
  FROM NHANVIEN;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MANV:=CONCAT('NV',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MANV);
END;
--TẠO MÃ PHIM
CREATE OR REPLACE FUNCTION ID_PHIM
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MAPHIM   VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MAPHIM,-5,5) AS NUMBER)) INTO LAST_VALUE FROM PHIM;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MAPHIM:=CONCAT('PH',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MAPHIM);
END;
--TẠO MÃ SUẤT CHIẾU
CREATE OR REPLACE FUNCTION ID_SUATCHIEU
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MASC     VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MASUATCHIEU,-5,5) AS NUMBER))
  INTO LAST_VALUE
  FROM SUATCHIEU;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MASC:=CONCAT('SC',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MASC);
END;
--TẠO MÃ SUẤT PHIM
CREATE OR REPLACE FUNCTION ID_SUATPHIM
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MASP     VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MASUATPHIM,-5,5) AS NUMBER))
  INTO LAST_VALUE
  FROM SUATPHIM;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MASP:=CONCAT('SP',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MASP);
END;
--TẠO MÃ THỰC PHẨM
CREATE OR REPLACE FUNCTION ID_THUCPHAM
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MATP     VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MATHUCPHAM,-5,5) AS NUMBER))
  INTO LAST_VALUE
  FROM THUCPHAM;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MATP:=CONCAT('TP',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MATP);
END;
--TẠO MÃ HỘI VIÊN
CREATE OR REPLACE FUNCTION ID_HOIVIEN
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MAHV     VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MAHOIVIEN,-5,5) AS NUMBER))
  INTO LAST_VALUE
  FROM HOIVIEN;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MAHV:=CONCAT('HV',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MAHV);
END;
--TẠO MÃ GHẾ
CREATE OR REPLACE FUNCTION ID_GHE
  RETURN VARCHAR2
AS
  LAST_VALUE NUMBER;
  V_MAGHE    VARCHAR2(7);
BEGIN
  SELECT MAX(CAST (SUBSTR(MAGHE,-5,5) AS NUMBER)) INTO LAST_VALUE FROM GHE;
  IF LAST_VALUE IS NULL THEN
    LAST_VALUE  :=0 ;
  END IF;
V_MAGHE:=CONCAT('GH',SUBSTR(CONCAT('00000',TO_CHAR(LAST_VALUE + 1)),-5,5));
RETURN(V_MAGHE);
END;
--HIỂN THỊ SUẤT CHIẾU
/*CREATE OR REPLACE PROCEDURE PRO_HIENTHI_SUATCHIEU
(V_MASC SUATCHIEU.MASUATCHIEU%TYPE)
IS
V_MASP SUATPHIM.MASUATPHIM%TYPE;
V_TENPHONG PHONGCHIEU.TENPHONG%TYPE;
V_TENPHIM PHIM.TENPHIM%TYPE;
BEGIN
SELECT SP.MASUATPHIM,TENPHONG,TENPHIM
INTO V_MASP,V_TENPHONG,V_TENPHIM
FROM SUATPHIM SP,PHIM P,PHONGCHIEU PC,SUATCHIEU SC
WHERE SP.MASUATPHIM=SC.MASUATPHIM
AND P.MAPHIM=SP.MAPHIM
AND PC.MAPHONG=SC.MAPHONG
AND MASUATCHIEU=V_MASC;
END;*/
--HIỂN THỊ SUẤT CHIẾU
/*CREATE OR REPLACE PROCEDURE PRO_HIENTHI_SUATCHIEU
(V_MASC SUATCHIEU.MASUATCHIEU%TYPE)
IS
  V_MASP SUATPHIM.MASUATPHIM%TYPE;
  V_TENDD DINHDANG.TENDINHDANG%TYPE;
  V_TENNN NGONNGU.TENNGONNGU%TYPE;
  V_TENHT HINHTHUC.TENHINHTHUC%TYPE;
  V_MAPHIM SUATPHIM.MAPHIM%TYPE;
BEGIN
  SELECT PHIM.MAPHIM
  INTO V_MAPHIM
  FROM PHIM,SUATCHIEU,SUATPHIM
  WHERE SUATCHIEU.MASUATPHIM=SUATPHIM.MASUATPHIM
  AND SUATPHIM.MAPHIM=PHIM.MAPHIM
  AND SUATCHIEU.MASUATCHIEU=V_MASC;
  
  SELECT MASUATPHIM,TENNGONNGU,TENDINHDANG,TENHINHTHUC
  INTO V_MASP,V_TENNN,V_TENDD,V_TENHT
  FROM SUATPHIM SP,DINHDANG DD,NGONNGU NN,HINHTHUC HT
  WHERE SP.MADINHDANG=DD.MADINHDANG
  AND SP.MANGONNGU=NN.MANGONNGU
  AND SP.MAHINHTHUC=HT.MAHINHTHUC
  AND SP.MAPHIM=V_MAPHIM;
END;*/
--INSERT GHẾ
CREATE OR REPLACE PROCEDURE PRO_INSERT_GHE(
      V_MAPHONG IN PHONGCHIEU.MAPHONG%TYPE)
  IS
  BEGIN
    FOR LOOP_COUNTER IN 01..48
    LOOP
      INSERT INTO GHE VALUES
        (ID_GHE(),V_MAPHONG,LOOP_COUNTER
        );
    END LOOP;
  END;
--LẤY DANH SÁCH GHẾ ĐÃ ĐẶT
CREATE OR REPLACE PROCEDURE PRO_BANVE_GHE
    (
      V_MASC IN VE.MASUATCHIEU%TYPE
    )
  IS
    V_SOGHE GHE.SOGHE%TYPE;
  BEGIN
    SELECT SOGHE
    INTO V_SOGHE
    FROM VE,
      GHE
    WHERE VE.MAGHE    =GHE.MAGHE
    AND VE.MASUATCHIEU=V_MASC;
  END;
--INSERT GHẾ THỬ
BEGIN
  PRO_INSERT_GHE('PC00001');
END;
SELECT * FROM GHE;
DELETE FROM GHE;
--HÀM INSERT PHIM
-- Tự xử thành công
/*CREATE OR REPLACE PROCEDURE PRO_INSERT_PHIM(
      V_MAPHIM        IN PHIM.MAPHIM%TYPE,
      V_TENPHIM       IN PHIM.TENPHIM%TYPE,
      V_THOILUONG     IN PHIM.THOILUONG%TYPE,
      V_THELOAI       IN PHIM.THELOAI%TYPE,
      V_NHASANXUAT    IN PHIM.NHASANXUAT%TYPE,
      V_NAMSANXUAT    IN PHIM.NAMSANXUAT%TYPE,
      V_DIENVIEN      IN PHIM.DIENVIEN%TYPE,
      V_NUOCSANXUAT   IN PHIM.NUOCSANXUAT%TYPE,
      V_NGAYKHOICHIEU IN PHIM.NGAYKHOICHIEU%TYPE,
      V_GIOIHANTUOI   IN PHIM.GIOIHANTUOI%TYPE,
      V_TOMTAT        IN PHIM.TOMTAT%TYPE,
      V_TRANGTHAI     IN PHIM.TRANGTHAI%TYPE)
  IS
  BEGIN
    INSERT
    INTO PHIM VALUES
      (
        V_MAPHIM,
        V_TENPHIM,
        V_THOILUONG,
        V_THELOAI,
        V_NHASANXUAT,
        V_NAMSANXUAT,
        V_DIENVIEN,
        V_NUOCSANXUAT,
        V_NGAYKHOICHIEU,
        V_GIOIHANTUOI,
        V_TOMTAT,
        V_TRANGTHAI
      );
  END;*/
--HÀM INSERT SUẤT PHIM
CREATE OR REPLACE PROCEDURE PRO_INSERT_SUATPHIM
    (
      V_MASUATPHIM IN SUATPHIM.MASUATPHIM%TYPE,
      V_NGONNGU    IN NGONNGU.TENNGONNGU%TYPE,
      V_DINHDANG   IN DINHDANG.TENDINHDANG%TYPE,
      V_MAPHIM     IN SUATPHIM.MAPHIM%TYPE,
      V_HINHTHUC   IN HINHTHUC.TENHINHTHUC%TYPE
    )
  IS
    V_MANGONNGU SUATPHIM.MANGONNGU%TYPE;
    V_MADINHDANG SUATPHIM.MADINHDANG%TYPE;
    V_MAHINHTHUC SUATPHIM.MAHINHTHUC%TYPE;
  BEGIN
    SELECT MANGONNGU INTO V_MANGONNGU FROM NGONNGU WHERE TENNGONNGU=V_NGONNGU;
    SELECT MADINHDANG
    INTO V_MADINHDANG
    FROM DINHDANG
    WHERE TENDINHDANG=V_DINHDANG;
    SELECT MAHINHTHUC
    INTO V_MAHINHTHUC
    FROM HINHTHUC
    WHERE TENHINHTHUC=V_HINHTHUC;
    INSERT
    INTO SUATPHIM VALUES
      (
        V_MASUATPHIM,
        V_MANGONNGU,
        V_MADINHDANG,
        V_MAPHIM,
        V_MAHINHTHUC
      );
  END;
--HÀM INSERT SUẤT PHIM VÀ PHIM
-- KHÔNG CẦN
/*CREATE OR REPLACE PROCEDURE PRO_INSERT_PHIM_SUATPHIM
(V_MAPHIM IN PHIM.MAPHIM%TYPE,
V_TENPHIM IN PHIM.TENPHIM%TYPE,
V_THOILUONG IN PHIM.THOILUONG%TYPE,
V_THELOAI IN PHIM.THELOAI%TYPE,
V_NHASANXUAT IN PHIM.NHASANXUAT%TYPE,
V_NAMSANXUAT IN PHIM.NAMSANXUAT%TYPE,
V_DIENVIEN IN PHIM.DIENVIEN%TYPE,
V_NUOCSANXUAT IN PHIM.NUOCSANXUAT%TYPE,
V_NGAYKHOICHIEU IN PHIM.NGAYKHOICHIEU%TYPE,
V_GIOIHANTUOI IN PHIM.GIOIHANTUOI%TYPE,
V_TOMTAT IN PHIM.TOMTAT%TYPE,
V_TRANGTHAI IN PHIM.TRANGTHAI%TYPE,
V_MASUATPHIM IN SUATPHIM.MASUATPHIM%TYPE,
V_NGONNGU IN NGONNGU.TENNGONNGU%TYPE,
V_DINHDANG IN DINHDANG.TENDINHDANG%TYPE,
V_HINHTHUC IN HINHTHUC.TENHINHTHUC%TYPE)
IS
BEGIN
PRO_INSERT_PHIM(V_MAPHIM,V_TENPHIM,V_THOILUONG,V_THELOAI,V_NHASANXUAT,V_NAMSANXUAT,V_DIENVIEN,V_NUOCSANXUAT,V_NGAYKHOICHIEU,V_GIOIHANTUOI,V_TOMTAT,V_TRANGTHAI);
PRO_INSERT_SUATPHIM(V_MASUATPHIM,V_NGONNGU,V_DINHDANG,V_MAPHIM,V_HINHTHUC);
END;*/
--TÌM MÃ SUẤT PHIM
CREATE OR REPLACE PROCEDURE FIND_ID_SP
    (
      V_TENPHIM IN PHIM.TENPHIM%TYPE
    )
  IS
    V_MASUATPHIM VARCHAR(7);
  BEGIN
    SELECT MASUATPHIM
    INTO V_MASUATPHIM
    FROM PHIM,
      SUATPHIM
    WHERE PHIM.MAPHIM=SUATPHIM.MAPHIM
    AND TENPHIM      =V_TENPHIM;
  END;
--HÀM THÊM SUẤT CHIẾU
/*
CREATE OR REPLACE PROCEDURE PRO_INSERT_SUATCHIEU
(V_MASC IN SUATCHIEU.MASUATCHIEU%TYPE,
V_TENPHONG IN PHONGCHIEU.TENPHONG%TYPE,
V_MASP IN SUATCHIEU.MASUATPHIM%TYPE,
V_THOIGIANCHIEU IN SUATCHIEU.THOIGIANCHIEU%TYPE)
IS
V_THOILUONG PHIM.THOILUONG%TYPE;
V_MAPHONG SUATCHIEU.MAPHONG%TYPE;
V_MASC_MIN SUATCHIEU.MASUATCHIEU%TYPE;
V_TL_MIN PHIM.THOILUONG%TYPE;
V_TGC_MIN SUATCHIEU.THOIGIANCHIEU%TYPE;
V_MASC_MAX SUATCHIEU.MASUATCHIEU%TYPE;
V_TGC_MAX SUATCHIEU.THOIGIANCHIEU%TYPE;
V_EXISTS_MIN NUMBER(3);
V_EXISTS_MAX NUMBER(3);
LOI_SC EXCEPTION;
BEGIN
SELECT MAPHONG
INTO V_MAPHONG
FROM PHONGCHIEU
WHERE TENPHONG=V_TENPHONG;
SELECT DISTINCT THOILUONG
INTO V_THOILUONG
FROM PHIM,SUATPHIM
WHERE PHIM.MAPHIM=SUATPHIM.MAPHIM
AND MASUATPHIM=V_MASP;
SELECT COUNT(*)
INTO V_EXISTS_MIN
FROM SUATCHIEU
WHERE MAPHONG=V_MAPHONG
AND THOIGIANCHIEU BETWEEN (V_THOIGIANCHIEU - INTERVAL '5' HOUR) AND V_THOIGIANCHIEU;--SUBTIME
SELECT COUNT(*)
INTO V_EXISTS_MAX
FROM SUATCHIEU
WHERE MAPHONG=V_MAPHONG
AND THOIGIANCHIEU BETWEEN V_THOIGIANCHIEU AND (V_THOIGIANCHIEU + INTERVAL '5' HOUR);--ADDTIME
IF V_EXISTS_MIN!=0 THEN
BEGIN
SELECT MASUATCHIEU
INTO V_MASC_MIN
FROM SUATCHIEU
WHERE MAPHONG=V_MAPHONG
AND THOIGIANCHIEU BETWEEN (V_THOIGIANCHIEU - INTERVAL '5' HOUR) AND V_THOIGIANCHIEU--SUBTIME
ORDER BY THOIGIANCHIEU DESC
FETCH FIRST 1 ROW ONLY;
SELECT THOIGIANCHIEU,THOILUONG
INTO V_TGC_MIN,V_TL_MIN
FROM PHIM,SUATCHIEU,SUATPHIM
WHERE PHIM.MAPHIM=SUATPHIM.MAPHIM
AND SUATCHIEU.MASUATPHIM=SUATPHIM.MASUATPHIM
AND MASUATCHIEU=V_MASC_MIN;
--67--
--V_TGTT:=(DATE_ADD(DATE_ADD(V_TGC_MIN,INTERVAL V_TL_MIN MINUTE),INTERVAL '40' MINUTE));
IF V_THOIGIANCHIEU<(V_TGC_MIN+INTERVAL '40' MINUTE+numtodsinterval(V_TL_MIN,'MINUTE'))
THEN RAISE LOI_SC;
ELSE
GOTO KT_TGIANSUATCHIEUSAU;
END IF;
END;
ELSE
GOTO KT_TGIANSUATCHIEUSAU;
END IF;
<<KT_TGIANSUATCHIEUSAU>>
BEGIN
IF V_EXISTS_MAX!=0 THEN
BEGIN
SELECT MASUATCHIEU
INTO V_MASC_MAX
FROM SUATCHIEU
WHERE MAPHONG=V_MAPHONG
AND THOIGIANCHIEU BETWEEN V_THOIGIANCHIEU AND (V_THOIGIANCHIEU+INTERVAL '5' HOUR)--ADDTIME
ORDER BY THOIGIANCHIEU ASC
FETCH FIRST 1 ROW ONLY;
SELECT THOIGIANCHIEU
INTO V_TGC_MAX
FROM SUATCHIEU
WHERE MASUATCHIEU=V_MASC_MAX;
--V_TGTD:=(DATE_ADD(DATE_ADD(V_THOIGIANCHIEU,INTERVAL V_THOILUONG MINUTE),INTERVAL '40' MINUTE));
IF V_TGC_MAX<(V_THOIGIANCHIEU+INTERVAL '40' MINUTE+numtodsinterval(V_THOILUONG,'MINUTE'))
THEN RAISE LOI_SC;
ELSE
GOTO THANH_CONG;
END IF;
END;
ELSE
GOTO THANH_CONG;
END IF;
END KT_TGIANSUATCHIEUSAU;
<<THANH_CONG>>
BEGIN
INSERT INTO SUATCHIEU VALUES (V_MASC,V_MAPHONG,V_MASP,V_THOIGIANCHIEU,'CÒN CHỖ');
DBMS_OUTPUT.PUT_LINE('LƯU THÀNH CÔNG');
END THANH_CONG;
EXCEPTION
WHEN LOI_SC THEN
DBMS_OUTPUT.PUT_LINE('CHỌN THỜI GIAN CHIẾU VÀ PHÒNG BỊ TRÙNG!');
END;
*/
--HÀM THÊM SUẤT CHIẾU
/
CREATE OR REPLACE PROCEDURE PRO_INSERT_SUATCHIEU(
      V_MASC          IN SUATCHIEU.MASUATCHIEU%TYPE,
      V_TENPHONG      IN PHONGCHIEU.TENPHONG%TYPE,
      V_MASP          IN SUATCHIEU.MASUATPHIM%TYPE,
      V_THOIGIANCHIEU IN SUATCHIEU.THOIGIANCHIEU%TYPE)
  IS
    V_THOILUONG PHIM.THOILUONG%TYPE;
    V_MAPHONG SUATCHIEU.MAPHONG%TYPE;
    V_MASC_MIN SUATCHIEU.MASUATCHIEU%TYPE;
    V_TL_MIN PHIM.THOILUONG%TYPE;
    V_TGC_MIN SUATCHIEU.THOIGIANCHIEU%TYPE;
    V_MASC_MAX SUATCHIEU.MASUATCHIEU%TYPE;
    V_TGC_MAX SUATCHIEU.THOIGIANCHIEU%TYPE;
    V_EXISTS_MIN NUMBER(3);
    V_EXISTS_MAX NUMBER(3);
  BEGIN
    SELECT MAPHONG INTO V_MAPHONG FROM PHONGCHIEU WHERE TENPHONG=V_TENPHONG;
    SELECT DISTINCT THOILUONG
    INTO V_THOILUONG
    FROM PHIM,
      SUATPHIM
    WHERE PHIM.MAPHIM=SUATPHIM.MAPHIM
    AND MASUATPHIM   =V_MASP;
    SELECT COUNT(*)
    INTO V_EXISTS_MIN
    FROM SUATCHIEU
    WHERE MAPHONG=V_MAPHONG
    AND THOIGIANCHIEU BETWEEN (V_THOIGIANCHIEU - INTERVAL '5' HOUR) AND V_THOIGIANCHIEU;--SUBTIME
    SELECT COUNT(                              *)
    INTO V_EXISTS_MAX
    FROM SUATCHIEU
    WHERE MAPHONG=V_MAPHONG
    AND THOIGIANCHIEU BETWEEN V_THOIGIANCHIEU AND (V_THOIGIANCHIEU + INTERVAL '5' HOUR);--ADDTIME
    IF V_EXISTS_MIN!=0 THEN
      BEGIN
        SELECT MASUATCHIEU
        INTO V_MASC_MIN
        FROM SUATCHIEU
        WHERE MAPHONG=V_MAPHONG
        AND THOIGIANCHIEU BETWEEN (V_THOIGIANCHIEU - INTERVAL '5' HOUR) AND V_THOIGIANCHIEU--SUBTIME
        ORDER BY THOIGIANCHIEU DESC
        FETCH FIRST 1 ROW ONLY;
        SELECT THOIGIANCHIEU,
          THOILUONG
        INTO V_TGC_MIN,
          V_TL_MIN
        FROM PHIM,
          SUATCHIEU,
          SUATPHIM
        WHERE PHIM.MAPHIM       =SUATPHIM.MAPHIM
        AND SUATCHIEU.MASUATPHIM=SUATPHIM.MASUATPHIM
        AND MASUATCHIEU         =V_MASC_MIN;
        --67--
        --V_TGTT:=(DATE_ADD(DATE_ADD(V_TGC_MIN,INTERVAL V_TL_MIN MINUTE),INTERVAL '40' MINUTE));
        IF V_THOIGIANCHIEU<(V_TGC_MIN+INTERVAL '40' MINUTE+numtodsinterval(V_TL_MIN,'MINUTE')) THEN
          RAISE_APPLICATION_ERROR(   -20000,'LỖI SUẤT CHIẾU TRƯỚC');
        ELSE
          GOTO KT_TGIANSUATCHIEUSAU;
        END IF;
      END;
    ELSE
      GOTO KT_TGIANSUATCHIEUSAU;
    END IF;
    <<KT_TGIANSUATCHIEUSAU>>
    BEGIN
      IF V_EXISTS_MAX!=0 THEN
        BEGIN
          SELECT MASUATCHIEU
          INTO V_MASC_MAX
          FROM SUATCHIEU
          WHERE MAPHONG=V_MAPHONG
          AND THOIGIANCHIEU BETWEEN V_THOIGIANCHIEU AND (V_THOIGIANCHIEU+INTERVAL '5' HOUR)--ADDTIME
          ORDER BY THOIGIANCHIEU ASC
          FETCH FIRST 1 ROW ONLY;
          SELECT THOIGIANCHIEU
          INTO V_TGC_MAX
          FROM SUATCHIEU
          WHERE MASUATCHIEU=V_MASC_MAX;
          --V_TGTD:=(DATE_ADD(DATE_ADD(V_THOIGIANCHIEU,INTERVAL V_THOILUONG MINUTE),INTERVAL '40' MINUTE));
          IF V_TGC_MAX<(V_THOIGIANCHIEU+INTERVAL '40' MINUTE+numtodsinterval(V_THOILUONG,'MINUTE')) THEN
            RAISE_APPLICATION_ERROR(   -20000,'LỖI SUẤT CHIẾU SAU');
          ELSE
            GOTO THANH_CONG;
          END IF;
        END;
      ELSE
        GOTO THANH_CONG;
      END IF;
    END KT_TGIANSUATCHIEUSAU;
    <<THANH_CONG>>
    BEGIN
      INSERT
      INTO SUATCHIEU VALUES
        (
          V_MASC,
          V_MAPHONG,
          V_MASP,
          V_THOIGIANCHIEU,
          'Còn chỗ'
        );
      DBMS_OUTPUT.PUT_LINE('LƯU THÀNH CÔNG');
    END THANH_CONG;
  END;
/
--THỬ THÊM SUẤT CHIẾU
SELECT * FROM SUATCHIEU;
INSERT
INTO SUATCHIEU VALUES
  (
    'SC00006',
    'PC00003',
    'SP00003',
    TO_TIMESTAMP('25/06/2017 16:00:00','DD/MM/YYYY HH24:MI:SS'),
    'Còn chỗ'
  );
BEGIN
  PRO_INSERT_SUATCHIEU('SC00017','PHÒNG 306','SP00003',TO_TIMESTAMP('25/06/2017 2:20:00','DD/MM/YYYY HH24:MI:SS'));
END;
SELECT * FROM SUATCHIEU;
SELECT * FROM SUATPHIM;
SELECT THOIGIANCHIEU + INTERVAL '30' MINUTE + numtodsinterval(20,'MINUTE')
FROM SUATCHIEU
WHERE MASUATCHIEU='SC00012';
--GIÁ VÉ
CREATE OR REPLACE FUNCTION FUNC_GIAVE(
    V_MASUATCHIEU IN VE.MASUATCHIEU%TYPE)
  RETURN NUMBER
IS
  V_GIAVE VE.GIAVE%TYPE;
  V_NGAY INTEGER;
  V_GIADINHDANG DINHDANG.GIADINHDANG%TYPE;
  V_KM SUKIEN.GIAMGIA%TYPE;
BEGIN
  V_NGAY:=(1+TRUNC(SYSDATE)-TRUNC(SYSDATE,'IW'));
  SELECT GIADINHDANG
  INTO V_GIADINHDANG
  FROM DINHDANG DD,
    SUATPHIM SP,
    SUATCHIEU SC
  WHERE DD.MADINHDANG=SP.MADINHDANG
  AND SC.MASUATPHIM  =SP.MASUATPHIM
  AND SC.MASUATCHIEU =V_MASUATCHIEU;
  IF V_NGAY          =6 OR V_NGAY=7 THEN
    V_GIAVE         :=15000;
  END IF;
SELECT GIAMGIA
INTO V_KM
FROM SUKIEN
WHERE SYSDATE BETWEEN NGAYBATDAU AND NGAYKETTHUC;
IF V_KM  IS NOT NULL THEN
  V_GIAVE:=((V_GIAVE+V_GIADINHDANG)*(1-V_KM));
ELSE
  V_GIAVE:=(V_GIAVE+V_GIADINHDANG);
END IF;
RETURN(V_GIAVE);
END;
--BÁN VÉ
CREATE OR REPLACE PROCEDURE PRO_BANVE(
      V_MAVE VE.MAVE%TYPE,
      V_MASC VE.MASUATCHIEU%TYPE,
      V_MANV VE.MANHANVIEN%TYPE,
      V_MAHV VE.MAHOIVIEN%TYPE,
      V_MAGHE VE.MAGHE%TYPE)
  IS
    V_MASK SUKIEN.MASUKIEN%TYPE;
    V_GIAVE VE.GIAVE%TYPE;
    V_COUNT_GHE INTEGER;
  BEGIN
    V_GIAVE:=FUNC_GIAVE(V_MASC);
    SELECT MASUKIEN
    INTO V_MASK
    FROM SUKIEN
    WHERE SYSDATE BETWEEN NGAYBATDAU AND NGAYKETTHUC;
    INSERT
    INTO VE VALUES
      (
        V_MAVE,
        V_MASC,
        V_MANV,
        V_MASK,
        V_MAHV,
        V_MAGHE,
        SYSDATE(),
        V_GIAVE
      );
    IF V_MAHV IS NOT NULL THEN
      UPDATE HOIVIEN
      SET DIEMTICHLUY=DIEMTICHLUY+V_GIAVE*0.001
      WHERE MAHOIVIEN=V_MAHV;
    END IF;
  END;
/*SELECT * FROM PHIM;
SELECT * FROM SUATPHIM;*/
--HÀM HIỂN THỊ SUẤT PHIM
/*CREATE OR REPLACE PROCEDURE PRO_HIENTHI_SUATPHIM
(V_MAPHIM PHIM.MAPHIM%TYPE)
IS
V_MASP SUATPHIM.MASUATPHIM%TYPE;
V_TENDD DINHDANG.TENDINHDANG%TYPE;
V_TENNN NGONNGU.TENNGONNGU%TYPE;
V_TENHT HINHTHUC.TENHINHTHUC%TYPE;
BEGIN
SELECT MASUATPHIM,TENNGONNGU,TENDINHDANG,TENHINHTHUC
INTO V_MASP,V_TENNN,V_TENDD,V_TENHT
FROM SUATPHIM SP,DINHDANG DD,NGONNGU NN,HINHTHUC HT
WHERE SP.MADINHDANG=DD.MADINHDANG
AND SP.MANGONNGU=NN.MANGONNGU
AND SP.MAHINHTHUC=HT.MAHINHTHUC
AND SP.MAPHIM=V_MAPHIM;
END;*/
--HIỂN THỊ SUẤT CHIẾU
CREATE OR REPLACE PROCEDURE PRO_HIENTHI_SUATCHIEU(
      V_MASC SUATCHIEU.MASUATCHIEU%TYPE)
  IS
    V_MASP SUATPHIM.MASUATPHIM%TYPE;
    V_TENDD DINHDANG.TENDINHDANG%TYPE;
    V_TENNN NGONNGU.TENNGONNGU%TYPE;
    V_TENHT HINHTHUC.TENHINHTHUC%TYPE;
    V_MAPHIM SUATPHIM.MAPHIM%TYPE;
  BEGIN
    SELECT PHIM.MAPHIM
    INTO V_MAPHIM
    FROM PHIM,
      SUATCHIEU,
      SUATPHIM
    WHERE SUATCHIEU.MASUATPHIM=SUATPHIM.MASUATPHIM
    AND SUATPHIM.MAPHIM       =PHIM.MAPHIM
    AND SUATCHIEU.MASUATCHIEU =V_MASC;
    SELECT MASUATPHIM,
      TENNGONNGU,
      TENDINHDANG,
      TENHINHTHUC
    INTO V_MASP,
      V_TENNN,
      V_TENDD,
      V_TENHT
    FROM SUATPHIM SP,
      DINHDANG DD,
      NGONNGU NN,
      HINHTHUC HT
    WHERE SP.MADINHDANG=DD.MADINHDANG
    AND SP.MANGONNGU   =NN.MANGONNGU
    AND SP.MAHINHTHUC  =HT.MAHINHTHUC
    AND SP.MAPHIM      =V_MAPHIM;
  END;
-- Edit hội viên
CREATE OR REPLACE PROCEDURE EDIT_HOIVIEN(
      V_MAHOIVIEN HOIVIEN.MAHOIVIEN%TYPE,
      V_HOTEN HOIVIEN.HOTEN%TYPE,
      V_GIOITINH HOIVIEN.GIOITINH%TYPE,
      V_CMND HOIVIEN.CMND%TYPE,
      V_NGAYSINH HOIVIEN.NGAYSINH%TYPE,
      V_EMAIL HOIVIEN.EMAIL%TYPE,
      V_DIENTHOAI HOIVIEN.DIENTHOAI%TYPE)
  AS
  BEGIN
    UPDATE HOIVIEN
    SET HOTEN      =V_HOTEN,
      GIOITINH     =V_GIOITINH,
      CMND         =V_CMND,
      NGAYSINH     =V_NGAYSINH,
      EMAIL        =V_EMAIL,
      DIENTHOAI    =V_DIENTHOAI
    WHERE MAHOIVIEN=V_MAHOIVIEN;
  END;
-- Edit thực phẩm
CREATE OR REPLACE PROCEDURE EDIT_THUCPHAM(
      V_MATP THUCPHAM.MATHUCPHAM%TYPE,
      V_TENTP THUCPHAM.TENTHUCPHAM%TYPE,
      V_DONGIA THUCPHAM.DONGIA%TYPE,
      V_SOLUONG THUCPHAM.SLUONG%TYPE,
      V_TRANGTHAI thucpham.trangthai%TYPE)
  AS
  BEGIN
    UPDATE THUCPHAM
    SET TENTHUCPHAM =V_TENTP,
      DONGIA        =v_dongia,
      SLUONG        =v_soluong,
      TRANGTHAI     =v_trangthai
    WHERE MATHUCPHAM=V_MATP;
  END;
  
--TRIGGER CẬP NHẬT TRẠNG THÁI VÀ SỐ LƯỢNG
CREATE OR REPLACE TRIGGER UPDATE_SOLUONG AFTER
  INSERT OR
  UPDATE ON CTHDTP FOR EACH ROW DECLARE V_SLUONG INTEGER;
  BEGIN
    UPDATE THUCPHAM
    SET SLUONG      =SLUONG - :NEW.SOLUONG
    WHERE MATHUCPHAM=:NEW.MATHUCPHAM;
    SELECT SLUONG INTO V_SLUONG FROM THUCPHAM WHERE MATHUCPHAM=:NEW.MATHUCPHAM;
    IF (V_SLUONG=0) THEN
      UPDATE THUCPHAM SET TRANGTHAI=0 WHERE MATHUCPHAM=:NEW.MATHUCPHAM;
    END IF;
  END;
